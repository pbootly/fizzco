<!doctype html><html lang=en-gb><head><meta charset=utf-8><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><meta name=viewport content="width=device-width,initial-scale=1"><title>FizzCo: Simple Go Profiling - Fizz Co.</title><meta name=author content="Matthew Thomas"><meta property="og:title" content="FizzCo: Simple Go Profiling"><meta property="og:description" content="Go Profiling - Using built in testing packages The app So looking at the application on the face of it there doesn&rsquo;t appear to be a whole lot to it, which at least from my perspective makes it pretty difficult to get into the meat of performance issues.
It&rsquo;s apparent that the real gains are going to be from the for loop:
for i := 0; i <= argVal; i++ { if (i%5 == 0) && (i%3 == 0) { fmt."><meta property="og:type" content="article"><meta property="og:url" content="http://blog.polybit.io/post/fizzco_simple_profiling/"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-08-20T00:00:00+00:00"><meta property="article:modified_time" content="2022-08-20T00:00:00+00:00"><meta property="og:see_also" content="http://blog.polybit.io/post/welcome_fizzco/"><meta name=twitter:card content="summary"><meta name=twitter:title content="FizzCo: Simple Go Profiling"><meta name=twitter:description content="Go Profiling - Using built in testing packages The app So looking at the application on the face of it there doesn&rsquo;t appear to be a whole lot to it, which at least from my perspective makes it pretty difficult to get into the meat of performance issues.
It&rsquo;s apparent that the real gains are going to be from the for loop:
for i := 0; i <= argVal; i++ { if (i%5 == 0) && (i%3 == 0) { fmt."><link rel=stylesheet href=/style.min.5297c96c59a52afaa5bcda4a6cedf3813081f64025c209b25b2ee6d0c8f74d462b625ad3404a92a14d7a51b4ec0a420337ae70f426fa4bce2d5f7459a3ca7274.css integrity="sha512-UpfJbFmlKvqlvNpKbO3zgTCB9kAlwgmyWy7m0Mj3TUYrYlrTQEqSoU16UbTsCkIDN65w9Cb6S84tX3RZo8pydA=="><script>localStorage.theme==="dark"||!("theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.setAttribute("data-theme","dark"):document.documentElement.setAttribute("data-theme","light")</script><script defer src=/js/header.7a2a109ec3782c57bad0332b662f8a5f41765505936b69868eb8bd5241de9daf23c388e82ca1831f6d09935013dcb9f71bfa7face3975880c1076028b7b0a6e1.js integrity="sha512-eioQnsN4LFe60DMrZi+KX0F2VQWTa2mGjri9UkHena8jw4joLKGDH20Jk1AT3Ln3G/p/rOOXWIDBB2Aot7Cm4Q=="></script>
<script defer src=/js/zooming.684b5d075bf94d0adfa21a7e7eb9acec1ddfb2e7b47d6657981617f0db0cf50949f1172801595afa3051f51b28d67f6a2d0c41be677b59b564307d9dbe4a4fd2.js integrity="sha512-aEtdB1v5TQrfohp+frms7B3fsue0fWZXmBYX8NsM9QlJ8RcoAVla+jBR9Rso1n9qLQxBvmd7WbVkMH2dvkpP0g=="></script>
<script defer src=/js/builtin-copy.56e07a74dd440b068ab36af35542ed8960865686c19fb809f38436877ac081570612cc8a913650b0c0e3073a336680c5df960e73bf7b1de83dc6aa996f2db858.js integrity="sha512-VuB6dN1ECwaKs2rzVULtiWCGVobBn7gJ84Q2h3rAgVcGEsyKkTZQsMDjBzozZoDF35YOc797Heg9xqqZby24WA=="></script></head><body><main><header><div class=brand><div id=sidebar_btn><svg id="menu_icon" width="26" height="26" viewBox="0 0 24 24"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></svg></div><div><a href=/>Fizz Co.</a></div></div><div class=toolbox><div id=theme_tool><svg id="dark_mode_btn" class="hidden toolbox-btn" width="18" height="18" viewBox="0 0 24 24"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></svg><svg id="light_mode_btn" class="hidden toolbox-btn" width="18" height="18" viewBox="0 0 24 24"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></svg></div></div></header><nav id=navbar class=pure-menu><ul class=pure-menu-list></ul></nav><div id=sidebar_canvas_overlay class=hidden></div><div id=sidebar class=close><ul></ul></div><div id=content class=content-margin><div class=collapsible-menu-wrapper><div class=collapsible-menu-type><span>Table of contents</span></div><div class=collapsible-menu><nav id=TableOfContents><ul><li><a href=#the-app>The app</a></li><li><a href=#a-small-restructure>A small restructure</a></li><li><a href=#our-simple-profile>Our simple profile</a></li></ul></nav></div></div><div class=content-margin><article class=line-numbers><h1 id=go-profiling---using-built-in-testing-packages>Go Profiling - Using built in testing packages</h1><h2 id=the-app>The app</h2><p>So looking at the application on the face of it there doesn&rsquo;t appear to be a whole lot to it, which at least from my perspective makes it pretty difficult to get into the meat of performance issues.</p><p>It&rsquo;s apparent that the real gains are going to be from the for loop:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>argVal</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>i</span><span style=color:#f92672>%</span><span style=color:#ae81ff>5</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) <span style=color:#f92672>&amp;&amp;</span> (<span style=color:#a6e22e>i</span><span style=color:#f92672>%</span><span style=color:#ae81ff>3</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;FizzBuzz&#34;</span>)
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span><span style=color:#f92672>%</span><span style=color:#ae81ff>5</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Buzz&#34;</span>)
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span><span style=color:#f92672>%</span><span style=color:#ae81ff>3</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Fizz&#34;</span>)
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We effectively have three conditionals:</p><ul><li>If a number is divisible by 5 and 3, print &ldquo;FizzBuzz&rdquo;</li><li>If a number is divisible by 5, print &ldquo;Buzz&rdquo;</li><li>Finally, if a number is divisible by 3, print &ldquo;Fizz&rdquo;</li></ul><p>There are a few places I&rsquo;d like to look at later to structure this logic in a more readable way (at least to me), but for now we&rsquo;ll focus on understanding the performance here, so that we can repeatably test for our change impact.</p><p>Another thing to note here is it looks like the algorithm has a time complexity of O(n), being linear is going to prove challenging to improve. Then again, BuzzCo must be doing <em>something</em> different.</p><h2 id=a-small-restructure>A small restructure</h2><p>I don&rsquo;t want to get too much change into the code just yet, but I&rsquo;ve taken the first codebase and split it into three files:</p><ul><li>main.go // This now simply takes the arguments and passes it to a function fizzBuzz/</li><li>fizz_buzz.go // this has our for loop above, taking the iterations in from main.go</li><li>fizz_buzz_test.go // This has currently one benchmark function for us to check CPU profiles.</li></ul><p>With that in mind, our benchmark function looks like so:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>BenchmarkFizzBuzz100</span>(<span style=color:#a6e22e>b</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>B</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>N</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fizzBuzz</span>(<span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>It simply runs the <code>fizzBuzz</code> function with 100 iterations b.N times. Whats neat about this is put quite succinctly from <a href=https://pkg.go.dev/testing>the go docs:</a></p><blockquote><p>During benchmark execution, b.N is adjusted until the benchmark function lasts long enough to be timed reliably.</p></blockquote><h2 id=our-simple-profile>Our simple profile</h2><p>With that setup, I can generate profiles with the following command:
<code>go test -cpuprofile benchmark.cpu.pb.gz -bench .</code></p><p>Then I can visualise things with a browser using:
<code>go tool pprof -http=:6061 benchmark.cpu.pb.gz</code></p><p><img src=/post/images/fizzco-flame-1.png alt=Flamegraph></p><p>With this all setup, we can start looking at what impact our changes make. Not bad for my first day, though I did skip lunch so I guess I&rsquo;ll call it there. As I&rsquo;m closing stuff down, I notice an unread notification on slack from a Kiefer S.</p><blockquote><p>&ldquo;Hey Bob, wondering if I can grab you tomorrow at 0900, there&rsquo;s ITS-1709 on in > JIRA and Keith assured me it would be done EOB Tuesday, which is tomorrow, > would be great to see what your thoughts are on a 24 hour turnaround?</p></blockquote><p><em>Shit</em>. I totally forgot about the JIRA tickets. Well I&rsquo;ll get myself home and maybe take a scan through after dinner. With a quick reply to Kiefer agreeing the morning meet would be okay I power down and get ready for bumper to bumper all the way home.</p></article></div></div></main></body></html>